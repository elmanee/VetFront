<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">

      <!-- Título principal del módulo (RQF01) -->
      <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-success text-white">
          <h2 class="h4 mb-0 text-center">Registro de Nueva Cita Médica</h2>
        </div>
        <div class="card-body">
          <p class="text-muted text-center mb-4">Módulo para Administrador/Recepcionista.</p>

          <!-- RQF01 - SALIDA ESPERADA: Mensaje de confirmación/error -->
          <div *ngIf="mensaje" class="alert d-flex align-items-center mb-4"
               [ngClass]="{'alert-info': mensajeClase === 'info',
                           'alert-success': mensajeClase === 'success',
                           'alert-danger': mensajeClase === 'error'}"
               role="alert">
            <i class="bi bi-info-circle-fill me-2" *ngIf="mensajeClase === 'info'"></i>
            <i class="bi bi-check-circle-fill me-2" *ngIf="mensajeClase === 'success'"></i>
            <i class="bi bi-exclamation-triangle-fill me-2" *ngIf="mensajeClase === 'error'"></i>
            <div class="text-center w-100">{{ mensaje }}</div>
          </div>

          <!-- RQF01 - ENTRADA DE DATOS: Formulario de Cita -->
          <!-- El (ngSubmit) es el punto donde se llama a la lógica de negocio (el Servicio) -->
          <form #citaForm="ngForm" (ngSubmit)="registrarCita()">

            <!-- GRUPO DE CAMPOS: TIEMPO -->
            <fieldset class="mb-4 p-3 border rounded-3">
              <legend class="float-none w-auto px-2 fs-6 text-success">Fecha y Hora</legend>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="fecha" class="form-label">Fecha de Cita (DD/MM/AAAA)</label>
                  <input type="date" id="fecha" name="fecha" class="form-control" [(ngModel)]="nuevaCita.fecha" required>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="hora" class="form-label">Hora de Cita (HH:MM)</label>
                  <input type="time" id="hora" name="hora" class="form-control" [(ngModel)]="nuevaCita.hora" required>
                </div>
              </div>
            </fieldset>

            <!-- GRUPO DE CAMPOS: PACIENTE Y VETERINARIO -->
            <fieldset class="mb-4 p-3 border rounded-3">
              <legend class="float-none w-auto px-2 fs-6 text-success">Paciente y Personal</legend>

              <!-- Campo 1: Cliente (Selección) -->
              <div class="mb-3">
                <label for="cliente" class="form-label">Cliente (Propietario)</label>
                <select id="cliente" name="cliente" class="form-select" [(ngModel)]="nuevaCita.clienteId" required>
                  <option [ngValue]="0" disabled>Seleccione un Cliente</option>
                  <option *ngFor="let cliente of clientes" [ngValue]="cliente.id">
                    {{ cliente.nombre }}
                  </option>
                </select>
              </div>

              <!-- Campo 2: Mascota (Selección) -->
              <div class="mb-3">
                <label for="mascota" class="form-label">Mascota (Paciente)</label>
                <select id="mascota" name="mascota" class="form-select" [(ngModel)]="nuevaCita.mascotaId" required>
                  <option [ngValue]="0" disabled>Seleccione una Mascota</option>
                  <!-- RQF01 - VALIDACIÓN VISUAL: Uso del Pipe para filtrar mascotas por el cliente seleccionado -->
                  <option *ngFor="let mascota of mascotas | filtroporCliente: nuevaCita.clienteId" [ngValue]="mascota.id">
                    {{ mascota.nombre }}
                  </option>
                </select>
                <!-- Advertencia si no hay cliente seleccionado -->
                <div *ngIf="nuevaCita.clienteId === 0" class="form-text text-danger">
                    Seleccione un cliente para ver sus mascotas asociadas.
                </div>
              </div>

              <!-- Campo 3: Veterinario (Selección - RQF01 VALIDACIÓN) -->
              <div class="mb-3">
                <label for="veterinario" class="form-label">Veterinario Asignado</label>
                <select id="veterinario" name="veterinario" class="form-select" [(ngModel)]="nuevaCita.veterinarioId" required>
                  <option [ngValue]="0" disabled>Seleccione un Veterinario</option>
                  <option *ngFor="let vet of veterinarios" [ngValue]="vet.id">
                    {{ vet.nombre }}
                  </option>
                </select>
              </div>
            </fieldset>

            <!-- GRUPO DE CAMPOS: DETALLES DE LA CITA -->
            <fieldset class="mb-4 p-3 border rounded-3">
              <legend class="float-none w-auto px-2 fs-6 text-success">Detalles y Contacto</legend>

              <!-- Campo 4: Motivo de Consulta (Cadena) -->
              <div class="mb-3">
                <label for="motivo" class="form-label">Motivo de Consulta (RQF01)</label>
                <textarea id="motivo" name="motivo" class="form-control" [(ngModel)]="nuevaCita.motivo" rows="3" required></textarea>
              </div>

              <!-- Campo 5: Teléfono de Contacto (Numérico) -->
              <div class="mb-3">
                <label for="telefono" class="form-label">Teléfono de Contacto (para recordatorios)</label>
                <!-- Usamos 'pattern' para una validación básica de número -->
                <input type="tel" id="telefono" name="telefono" class="form-control" [(ngModel)]="nuevaCita.telefonoContacto" pattern="[0-9]{10}" required>
                <div *ngIf="citaForm.controls['telefono']?.invalid && citaForm.controls['telefono']?.dirty" class="form-text text-danger">
                  Debe ser un número de 10 dígitos.
                </div>
              </div>
            </fieldset>

            <!-- Botón de Registro -->
            <button type="submit" [disabled]="!citaForm.valid" class="btn btn-success btn-lg w-100">
              Registrar Cita y Validar Horario
            </button>
            <small class="d-block text-center mt-2 text-muted">La validación de disponibilidad se realiza antes de enviar.</small>
          </form>

        </div>
      </div>
    </div>
  </div>
</div>
