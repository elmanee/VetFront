<div class="container-fluid min-vh-100 bg-light py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      
      <!-- Header -->
      <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-dark mb-2">
          <i class="bi bi-search me-2"></i>
          Buscar Expedientes Médicos
        </h1>
        <p class="lead text-muted">
          RQF02 - Búsqueda con múltiples criterios
        </p>
      </div>

      <!-- Panel de búsqueda -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-funnel me-2"></i>
            Criterios de Búsqueda (mínimo 1 filtro)
          </h5>
        </div>
        <div class="card-body p-4">
          <div class="row g-3">
            
            <!-- Filtro 1: Nombre de mascota -->
            <div class="col-md-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-heart-fill text-danger me-1"></i>
                Nombre de Mascota
              </label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="filtros.nombreMascota"
                placeholder="Ej: Max, Luna...">
            </div>

            <!-- Filtro 2: Propietario -->
            <div class="col-md-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-person-fill text-primary me-1"></i>
                Propietario
              </label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="filtros.propietario"
                placeholder="Nombre del dueño...">
            </div>

            <!-- Filtro 3: Número de expediente -->
            <div class="col-md-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-folder2-open text-warning me-1"></i>
                Número de Expediente
              </label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="filtros.numeroExpediente"
                placeholder="Ej: EXP-2025-00001">
            </div>

            <!-- Filtro 4: Fecha de consulta -->
            <div class="col-md-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-calendar3 text-info me-1"></i>
                Fecha de Consulta
              </label>
              <input 
                type="date" 
                class="form-control" 
                [(ngModel)]="filtros.fechaConsulta">
            </div>

            <!-- Filtro 5: Diagnóstico -->
            <div class="col-md-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-clipboard-check text-success me-1"></i>
                Diagnóstico
              </label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="filtros.diagnostico"
                placeholder="Palabra clave...">
            </div>

            <!-- Filtro 6: Estado -->
            <div class="col-md-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-toggle-on text-secondary me-1"></i>
                Estado
              </label>
              <select class="form-select" [(ngModel)]="filtros.estado">
                <option value="">Todos</option>
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
              </select>
            </div>

          </div>

          <!-- Botones de acción -->
          <div class="row mt-4">
            <div class="col-md-6">
              <button 
                class="btn btn-outline-secondary w-100"
                (click)="limpiarFiltros()"
                [disabled]="buscando">
                <i class="bi bi-x-circle me-2"></i>
                Limpiar Filtros
              </button>
            </div>
            <div class="col-md-6">
              <button 
                class="btn btn-primary w-100"
                (click)="buscarExpedientes()"
                [disabled]="buscando">
                <span *ngIf="!buscando">
                  <i class="bi bi-search me-2"></i>
                  Buscar Expedientes
                </span>
                <span *ngIf="buscando">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Buscando...
                </span>
              </button>
            </div>
          </div>

          <!-- Indicador de filtros activos -->
          <div class="mt-3" *ngIf="contarFiltrosActivos() > 0">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Filtros activos: <strong>{{ contarFiltrosActivos() }}</strong>
            </small>
          </div>
        </div>
      </div>

      <!-- Mensajes -->
      <div *ngIf="mensaje" class="alert alert-dismissible fade show" 
           [ngClass]="{
             'alert-success': mensajeClase === 'success',
             'alert-danger': mensajeClase === 'error',
             'alert-info': mensajeClase === 'info',
             'alert-warning': mensajeClase === 'warning'
           }"
           role="alert">
        <i class="bi me-2" 
           [ngClass]="{
             'bi-check-circle-fill': mensajeClase === 'success',
             'bi-exclamation-triangle-fill': mensajeClase === 'error' || mensajeClase === 'warning',
             'bi-info-circle-fill': mensajeClase === 'info'
           }"></i>
        {{ mensaje }}
        <button type="button" class="btn-close" (click)="mensaje = ''" aria-label="Close"></button>
      </div>

      <!-- Resultados -->
      <div *ngIf="busquedaRealizada && !buscando">
        
        <!-- Sin resultados -->
        <div *ngIf="expedientes.length === 0" class="card border-0 shadow-sm">
          <div class="card-body text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h4 class="mt-3 text-muted">No se encontraron expedientes</h4>
            <p class="text-muted">Intente con otros criterios de búsqueda</p>
          </div>
        </div>

        <!-- Con resultados -->
        <div *ngIf="expedientes.length > 0">
          
          <!-- Contador de resultados -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
              Resultados: <span class="badge bg-primary">{{ expedientes.length }}</span>
            </h5>
            <small class="text-muted">
              Mostrando {{ (paginaActual - 1) * itemsPorPagina + 1 }} - 
              {{ Math.min(paginaActual * itemsPorPagina, expedientes.length) }} 
              de {{ expedientes.length }}
            </small>
          </div>

          <!-- Tarjetas de expedientes -->
          <div class="row g-3">
            <div class="col-md-6 col-lg-4" *ngFor="let exp of expedientesPaginados">
              <div class="card h-100 border-0 shadow-sm hover-card">
                <div class="card-body">
                  
                  <!-- Header de la tarjeta -->
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <h6 class="fw-bold text-primary mb-1">{{ exp.numero_expediente }}</h6>
                      <span class="badge" [class.bg-success]="exp.estado === 'Activo'" 
                            [class.bg-secondary]="exp.estado !== 'Activo'">
                        {{ exp.estado }}
                      </span>
                    </div>
                    <i class="bi bi-folder2-open fs-2 text-warning"></i>
                  </div>

                  <!-- Información de la mascota -->
                  <div class="mb-3">
                    <h5 class="fw-bold mb-2">
                      <i class="bi bi-heart-fill text-danger me-1"></i>
                      {{ exp.mascota_nombre }}
                    </h5>
                    <p class="mb-1 small text-muted">
                      <strong>Especie:</strong> {{ exp.tipo_animal }}
                    </p>
                    <p class="mb-1 small text-muted" *ngIf="exp.raza">
                      <strong>Raza:</strong> {{ exp.raza }}
                    </p>
                    <p class="mb-1 small text-muted" *ngIf="exp.sexo">
                      <strong>Sexo:</strong> {{ exp.sexo }}
                    </p>
                    <p class="mb-0 small text-muted" *ngIf="exp.edad">
                      <strong>Edad:</strong> {{ exp.edad }} años
                    </p>
                  </div>

                  <!-- Información del propietario -->
                  <div class="mb-3 pb-3 border-bottom">
                    <p class="mb-1 small">
                      <i class="bi bi-person-fill text-primary me-1"></i>
                      <strong>{{ exp.propietario }}</strong>
                    </p>
                    <p class="mb-0 small text-muted">
                      <i class="bi bi-telephone-fill me-1"></i>
                      {{ exp.telefono }}
                    </p>
                  </div>

                  <!-- Estadísticas -->
                  <div class="mb-3">
                    <div class="row text-center">
                      <div class="col-6">
                        <div class="small text-muted">Consultas</div>
                        <div class="fw-bold fs-5 text-primary">{{ exp.total_consultas || 0 }}</div>
                      </div>
                      <div class="col-6">
                        <div class="small text-muted">Última consulta</div>
                        <div class="fw-bold small">
                          {{ exp.ultima_consulta ? formatearFecha(exp.ultima_consulta) : 'N/A' }}
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Botón de acción -->
                  <button 
                    class="btn btn-primary w-100"
                    (click)="verExpediente(exp)">
                    <i class="bi bi-eye me-2"></i>
                    Ver Expediente Completo
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Paginación -->
          <nav *ngIf="totalPaginas > 1" class="mt-4">
            <ul class="pagination justify-content-center">
              <li class="page-item" [class.disabled]="paginaActual === 1">
                <a class="page-link" (click)="cambiarPagina(paginaActual - 1)">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>
              <li class="page-item" *ngFor="let num of numerosPaginas" 
                  [class.active]="num === paginaActual">
                <a class="page-link" (click)="cambiarPagina(num)">{{ num }}</a>
              </li>
              <li class="page-item" [class.disabled]="paginaActual === totalPaginas">
                <a class="page-link" (click)="cambiarPagina(paginaActual + 1)">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
.hover-card {
  transition: transform 0.2s, box-shadow 0.2s;
}

.hover-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.2) !important;
}

.page-link {
  cursor: pointer;
}
</style>