<div class="container-fluid min-vh-100 bg-light py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      
      <!-- Header -->
      <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-dark mb-2">
          <i class="bi bi-clipboard2-pulse me-2"></i>
          Registro de Consulta Médica
        </h1>
        <p class="lead text-muted">
          Complete el expediente médico del paciente
        </p>
      </div>

      <!-- Información del Expediente -->
      <div class="card border-0 shadow-sm mb-4" *ngIf="expediente && !cargandoExpediente">
        <div class="card-body p-4 bg-primary bg-opacity-10">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="fw-bold mb-2">
                <i class="bi bi-folder2-open me-2 text-primary"></i>
                Expediente: {{ expediente.numero_expediente }}
              </h5>
              <div class="row">
                <div class="col-md-6">
                  <p class="mb-1"><strong>Mascota:</strong> {{ expediente.mascota_nombre }}</p>
                  <p class="mb-1"><strong>Especie:</strong> {{ expediente.tipo_animal }}</p>
                  <p class="mb-1"><strong>Raza:</strong> {{ expediente.raza || 'No especificada' }}</p>
                </div>
                <div class="col-md-6">
                  <p class="mb-1"><strong>Sexo:</strong> {{ expediente.sexo || 'No especificado' }}</p>
                  <p class="mb-1"><strong>Edad:</strong> {{ expediente.edad || 'No especificada' }} años</p>
                  <p class="mb-1"><strong>Peso anterior:</strong> {{ expediente.peso || 'No registrado' }} kg</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 text-md-end">
              <p class="mb-1"><strong>Propietario:</strong></p>
              <p class="mb-1">{{ expediente.propietario }}</p>
              <p class="mb-0 text-muted small">{{ expediente.telefono }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading expediente -->
      <div class="text-center py-5" *ngIf="cargandoExpediente">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando expediente...</span>
        </div>
        <p class="text-muted mt-3">Cargando información del expediente...</p>
      </div>

      <!-- FORMULARIO PRINCIPAL -->
      <form *ngIf="!cargandoExpediente">

        <!-- SECCIÓN 1: SIGNOS VITALES -->
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-header bg-white border-0 cursor-pointer" (click)="toggleSeccion('signosVitales')">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold">
                <i class="bi bi-heart-pulse me-2 text-danger"></i>
                Signos Vitales
              </h5>
              <i class="bi" [ngClass]="seccionesExpandidas.signosVitales ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
            </div>
          </div>
          <div class="card-body" *ngIf="seccionesExpandidas.signosVitales">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-speedometer2 me-1"></i>
                  Peso (kg)
                </label>
                <input 
                  type="number" 
                  class="form-control" 
                  [(ngModel)]="signosVitales.peso"
                  name="peso"
                  step="0.01"
                  min="0"
                  placeholder="Ej: 15.5">
              </div>
              <div class="col-md-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-thermometer-half me-1"></i>
                  Temperatura (°C)
                </label>
                <input 
                  type="number" 
                  class="form-control" 
                  [(ngModel)]="signosVitales.temperatura"
                  name="temperatura"
                  step="0.1"
                  min="30"
                  max="45"
                  placeholder="Ej: 38.5">
                <small class="text-muted">Rango: 30-45°C</small>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-heart me-1"></i>
                  Frec. Cardíaca (lpm)
                </label>
                <input 
                  type="number" 
                  class="form-control" 
                  [(ngModel)]="signosVitales.frecuencia_cardiaca"
                  name="frecuenciaCardiaca"
                  min="30"
                  max="300"
                  placeholder="Ej: 120">
                <small class="text-muted">Rango: 30-300 lpm</small>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-lungs me-1"></i>
                  Frec. Respiratoria (rpm)
                </label>
                <input 
                  type="number" 
                  class="form-control" 
                  [(ngModel)]="signosVitales.frecuencia_respiratoria"
                  name="frecuenciaRespiratoria"
                  min="5"
                  max="100"
                  placeholder="Ej: 30">
                <small class="text-muted">Rango: 5-100 rpm</small>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCIÓN 2: MOTIVO Y SÍNTOMAS -->
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-body p-4">
            <h5 class="fw-bold mb-3">
              <i class="bi bi-file-text me-2 text-primary"></i>
              Motivo de Consulta y Síntomas
            </h5>
            
            <div class="mb-3">
              <label class="form-label fw-semibold">
                Motivo de Consulta <span class="text-danger">*</span>
              </label>
              <textarea 
                class="form-control" 
                [(ngModel)]="motivoConsulta"
                name="motivoConsulta"
                rows="2"
                required
                placeholder="Describa el motivo principal de la consulta..."></textarea>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-semibold">Síntomas Observados</label>
              <textarea 
                class="form-control" 
                [(ngModel)]="sintomas"
                name="sintomas"
                rows="3"
                placeholder="Describa los síntomas que presenta el paciente..."></textarea>
            </div>
            
            <div class="mb-0">
              <label class="form-label fw-semibold">Observaciones Generales</label>
              <textarea 
                class="form-control" 
                [(ngModel)]="observaciones"
                name="observaciones"
                rows="2"
                placeholder="Observaciones adicionales sobre la consulta..."></textarea>
            </div>
          </div>
        </div>

        <!-- SECCIÓN 3: DIAGNÓSTICOS -->
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-header bg-white border-0 cursor-pointer" (click)="toggleSeccion('diagnosticos')">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold">
                <i class="bi bi-clipboard-check me-2 text-success"></i>
                Diagnósticos <span class="badge bg-success">{{ diagnosticos.length }}</span>
                <span class="text-danger ms-2">*</span>
              </h5>
              <i class="bi" [ngClass]="seccionesExpandidas.diagnosticos ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
            </div>
          </div>
          <div class="card-body" *ngIf="seccionesExpandidas.diagnosticos">
            
            <!-- Lista de diagnósticos -->
            <div class="mb-3" *ngIf="diagnosticos.length > 0">
              <div class="alert alert-success mb-2" *ngFor="let diag of diagnosticos; let i = index">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong>{{ diag.descripcion }}</strong>
                    <span class="badge bg-info ms-2">{{ diag.tipo }}</span>
                  </div>
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-danger"
                    (click)="eliminarDiagnostico(i)">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Formulario para agregar diagnóstico -->
            <div class="border rounded p-3 bg-light">
              <h6 class="fw-bold mb-3">Agregar Diagnóstico</h6>
              <div class="row g-3">
                <div class="col-md-8">
                  <label class="form-label">Descripción del Diagnóstico</label>
                  <textarea 
                    class="form-control" 
                    [(ngModel)]="nuevoDiagnostico.descripcion"
                    name="nuevoDiagnosticoDesc"
                    rows="2"
                    placeholder="Ej: Gastroenteritis aguda..."></textarea>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Tipo</label>
                  <select class="form-select" [(ngModel)]="nuevoDiagnostico.tipo" name="nuevoDiagnosticoTipo">
                    <option *ngFor="let tipo of tiposDiagnostico" [value]="tipo">{{ tipo }}</option>
                  </select>
                </div>
              </div>
              <button 
                type="button" 
                class="btn btn-success mt-3"
                (click)="agregarDiagnostico()">
                <i class="bi bi-plus-circle me-2"></i>
                Agregar Diagnóstico
              </button>
            </div>
          </div>
        </div>

        <!-- SECCIÓN 4: TRATAMIENTOS -->
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-header bg-white border-0 cursor-pointer" (click)="toggleSeccion('tratamientos')">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold">
                <i class="bi bi-capsule me-2 text-primary"></i>
                Tratamientos <span class="badge bg-primary">{{ tratamientos.length }}</span>
              </h5>
              <i class="bi" [ngClass]="seccionesExpandidas.tratamientos ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
            </div>
          </div>
          <div class="card-body" *ngIf="seccionesExpandidas.tratamientos">
            
            <!-- Lista de tratamientos -->
            <div class="mb-3" *ngIf="tratamientos.length > 0">
              <div class="alert alert-primary mb-2" *ngFor="let trat of tratamientos; let i = index">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong>{{ trat.medicamento }}</strong><br>
                    <small>Dosis: {{ trat.dosis }} | Frecuencia: {{ trat.frecuencia }}</small>
                    <span *ngIf="trat.duracion_dias" class="ms-2 badge bg-info">{{ trat.duracion_dias }} días</span>
                  </div>
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-danger"
                    (click)="eliminarTratamiento(i)">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Formulario para agregar tratamiento -->
            <div class="border rounded p-3 bg-light">
              <h6 class="fw-bold mb-3">Agregar Tratamiento</h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Medicamento</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="nuevoTratamiento.medicamento"
                    name="nuevoTratMedicamento"
                    placeholder="Ej: Amoxicilina">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Dosis</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="nuevoTratamiento.dosis"
                    name="nuevoTratDosis"
                    placeholder="Ej: 10mg">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Duración (días)</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    [(ngModel)]="nuevoTratamiento.duracion_dias"
                    name="nuevoTratDuracion"
                    placeholder="Ej: 7">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Frecuencia</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="nuevoTratamiento.frecuencia"
                    name="nuevoTratFrecuencia"
                    placeholder="Ej: Cada 8 horas">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Vía de Administración</label>
                  <select class="form-select" [(ngModel)]="nuevoTratamiento.via_administracion" name="nuevoTratVia">
                    <option value="">Seleccionar...</option>
                    <option *ngFor="let via of viasAdministracion" [value]="via">{{ via }}</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">Indicaciones</label>
                  <textarea 
                    class="form-control" 
                    [(ngModel)]="nuevoTratamiento.indicaciones"
                    name="nuevoTratIndicaciones"
                    rows="2"
                    placeholder="Indicaciones especiales para el tratamiento..."></textarea>
                </div>
              </div>
              <button 
                type="button" 
                class="btn btn-primary mt-3"
                (click)="agregarTratamiento()">
                <i class="bi bi-plus-circle me-2"></i>
                Agregar Tratamiento
              </button>
            </div>
          </div>
        </div>

        <!-- SECCIÓN 5: VACUNAS -->
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-header bg-white border-0 cursor-pointer" (click)="toggleSeccion('vacunas')">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold">
                <i class="bi bi-shield-fill-check me-2 text-info"></i>
                Vacunas <span class="badge bg-info">{{ vacunas.length }}</span>
              </h5>
              <i class="bi" [ngClass]="seccionesExpandidas.vacunas ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
            </div>
          </div>
          <div class="card-body" *ngIf="seccionesExpandidas.vacunas">
            
            <!-- Lista de vacunas -->
            <div class="mb-3" *ngIf="vacunas.length > 0">
              <div class="alert alert-info mb-2" *ngFor="let vac of vacunas; let i = index">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong>{{ vac.nombre_vacuna }}</strong><br>
                    <small *ngIf="vac.sitio_aplicacion">Sitio: {{ vac.sitio_aplicacion }}</small>
                    <small *ngIf="vac.proxima_dosis" class="ms-2">Próxima: {{ vac.proxima_dosis }}</small>
                  </div>
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-danger"
                    (click)="eliminarVacuna(i)">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Formulario para agregar vacuna -->
            <div class="border rounded p-3 bg-light">
              <h6 class="fw-bold mb-3">Agregar Vacuna</h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nombre de la Vacuna</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="nuevaVacuna.nombre_vacuna"
                    name="nuevaVacunaNombre"
                    placeholder="Ej: Rabia, Parvovirus...">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Fecha Aplicación</label>
                  <input 
                    type="date" 
                    class="form-control" 
                    [(ngModel)]="nuevaVacuna.fecha_aplicacion"
                    name="nuevaVacunaFecha">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Próxima Dosis</label>
                  <input 
                    type="date" 
                    class="form-control" 
                    [(ngModel)]="nuevaVacuna.proxima_dosis"
                    name="nuevaVacunaProxima">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Sitio de Aplicación</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="nuevaVacuna.sitio_aplicacion"
                    name="nuevaVacunaSitio"
                    placeholder="Ej: Subcutánea en cuello">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Reacciones Adversas</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="nuevaVacuna.reacciones_adversas"
                    name="nuevaVacunaReacciones"
                    placeholder="Si hubo alguna reacción...">
                </div>
              </div>
              <button 
                type="button" 
                class="btn btn-info mt-3"
                (click)="agregarVacuna()">
                <i class="bi bi-plus-circle me-2"></i>
                Agregar Vacuna
              </button>
            </div>
          </div>
        </div>

        <!-- SECCIÓN 6: PROCEDIMIENTOS -->
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-header bg-white border-0 cursor-pointer" (click)="toggleSeccion('procedimientos')">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold">
                <i class="bi bi-scissors me-2 text-warning"></i>
                Procedimientos <span class="badge bg-warning text-dark">{{ procedimientos.length }}</span>
              </h5>
              <i class="bi" [ngClass]="seccionesExpandidas.procedimientos ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
            </div>
          </div>
          <div class="card-body" *ngIf="seccionesExpandidas.procedimientos">
            
            <!-- Lista de procedimientos -->
            <div class="mb-3" *ngIf="procedimientos.length > 0">
              <div class="alert alert-warning mb-2" *ngFor="let proc of procedimientos; let i = index">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong>{{ proc.nombre_procedimiento }}</strong>
                    <span class="badge bg-secondary ms-2">{{ proc.tipo_procedimiento }}</span><br>
                    <small>{{ proc.descripcion }}</small>
                  </div>
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-danger"
                    (click)="eliminarProcedimiento(i)">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Formulario para agregar procedimiento -->
            <div class="border rounded p-3 bg-light">
              <h6 class="fw-bold mb-3">Agregar Procedimiento</h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Tipo de Procedimiento</label>
                  <select class="form-select" [(ngModel)]="nuevoProcedimiento.tipo_procedimiento" name="nuevoProcTipo">
                    <option value="">Seleccionar...</option>
                    <option *ngFor="let tipo of tiposProcedimiento" [value]="tipo">{{ tipo }}</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Nombre del Procedimiento</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="nuevoProcedimiento.nombre_procedimiento"
                    name="nuevoProcNombre"
                    placeholder="Ej: Extracción dental">
                </div>
                <div class="col-12">
                  <label class="form-label">Descripción</label>
                  <textarea 
                    class="form-control" 
                    [(ngModel)]="nuevoProcedimiento.descripcion"
                    name="nuevoProcDesc"
                    rows="2"
                    placeholder="Describa el procedimiento realizado..."></textarea>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Fecha Realización</label>
                  <input 
                    type="date" 
                    class="form-control" 
                    [(ngModel)]="nuevoProcedimiento.fecha_realizacion"
                    name="nuevoProcFecha">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Hora Inicio</label>
                  <input 
                    type="time" 
                    class="form-control" 
                    [(ngModel)]="nuevoProcedimiento.hora_inicio"
                    name="nuevoProcHoraInicio">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Hora Fin</label>
                  <input 
                    type="time" 
                    class="form-control" 
                    [(ngModel)]="nuevoProcedimiento.hora_fin"
                    name="nuevoProcHoraFin">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Anestesia Utilizada</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="nuevoProcedimiento.anestesia_utilizada"
                    name="nuevoProcAnestesia"
                    placeholder="Tipo de anestesia...">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Complicaciones</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="nuevoProcedimiento.complicaciones"
                    name="nuevoProcComplicaciones"
                    placeholder="Si hubo complicaciones...">
                </div>
              </div>
              <button 
                type="button" 
                class="btn btn-warning mt-3"
                (click)="agregarProcedimiento()">
                <i class="bi bi-plus-circle me-2"></i>
                Agregar Procedimiento
              </button>
            </div>
          </div>
        </div>

        <!-- SECCIÓN 7: IMÁGENES -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-0 cursor-pointer" (click)="toggleSeccion('imagenes')">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold">
                <i class="bi bi-images me-2 text-secondary"></i>
                Imágenes Adjuntas <span class="badge bg-secondary">{{ imagenes.length }}</span>
              </h5>
              <i class="bi" [ngClass]="seccionesExpandidas.imagenes ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
            </div>
          </div>
          <div class="card-body" *ngIf="seccionesExpandidas.imagenes">
            
            <!-- Lista de imágenes -->
            <div class="row g-3 mb-3" *ngIf="imagenes.length > 0">
              <div class="col-md-4" *ngFor="let img of imagenes; let i = index">
                <div class="card border">
                  <img [src]="img.imagen_base64" class="card-img-top" style="height: 200px; object-fit: cover;">
                  <div class="card-body p-2">
                    <input 
                      type="text" 
                      class="form-control form-control-sm mb-1" 
                      [(ngModel)]="img.descripcion"
                      [name]="'imgDesc' + i"
                      placeholder="Descripción...">
                    <select class="form-select form-select-sm mb-2" [(ngModel)]="img.tipo_imagen" [name]="'imgTipo' + i">
                      <option *ngFor="let tipo of tiposImagen" [value]="tipo">{{ tipo }}</option>
                    </select>
                    <button 
                      type="button" 
                      class="btn btn-sm btn-danger w-100"
                      (click)="eliminarImagen(i)">
                      <i class="bi bi-trash me-1"></i> Eliminar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botón para agregar imagen -->
            <div class="text-center">
              <label class="btn btn-outline-secondary">
                <i class="bi bi-cloud-upload me-2"></i>
                Seleccionar Imagen
                <input 
                  type="file" 
                  accept="image/*" 
                  class="d-none"
                  (change)="onImagenSeleccionada($event)">
              </label>
              <p class="text-muted small mt-2 mb-0">Tamaño máximo: 5MB | Formatos: JPG, PNG, GIF</p>
            </div>
          </div>
        </div>

        <!-- BOTONES DE ACCIÓN -->
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <div class="row g-3">
              <div class="col-md-6">
                <button 
                  type="button" 
                  class="btn btn-secondary btn-lg w-100"
                  (click)="cancelar()"
                  [disabled]="guardando">
                  <i class="bi bi-x-circle me-2"></i>
                  Cancelar
                </button>
              </div>
              <div class="col-md-6">
                <button 
                  type="button" 
                  class="btn btn-success btn-lg w-100"
                  (click)="guardarConsulta()"
                  [disabled]="guardando || cargandoExpediente">
                  <span *ngIf="!guardando">
                    <i class="bi bi-check-circle me-2"></i>
                    Guardar Consulta Médica
                  </span>
                  <span *ngIf="guardando">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Guardando...
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>

      </form>

    </div>
  </div>
</div>

<style>
.cursor-pointer {
  cursor: pointer;
}

.cursor-pointer:hover {
  background-color: #f8f9fa;
}
</style>