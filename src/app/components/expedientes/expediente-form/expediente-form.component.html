<div class="container-fluid min-vh-100 bg-light py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      
      <!-- Encabezado -->
      <div class="text-center mb-4">
        <h1 class="display-6 fw-bold text-dark mb-3">
          <i class="bi bi-clipboard2-pulse me-2"></i>
          Registro de Consulta Médica
        </h1>
        <p class="lead text-muted">
          Formulario completo para expediente médico veterinario
        </p>
      </div>

      <!-- Información de la Cita -->
      <div class="card border-0 shadow-sm mb-4" *ngIf="citaInfo">
        <div class="card-body p-4 bg-primary bg-opacity-10">
          <div class="row">
            <div class="col-md-3">
              <strong>Cita #{{ citaInfo.id_cita }}</strong>
            </div>
            <div class="col-md-3">
              <i class="bi bi-calendar3 me-1"></i> {{ citaInfo.fecha_cita }}
            </div>
            <div class="col-md-3">
              <i class="bi bi-clock me-1"></i> {{ citaInfo.hora_cita }}
            </div>
            <div class="col-md-3">
              <span class="badge bg-success">Confirmada</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensajes -->
      <div *ngIf="mensaje" class="alert alert-dismissible fade show" 
           [ngClass]="{'alert-success': mensajeClase === 'success', 'alert-danger': mensajeClase === 'error'}">
        {{ mensaje }}
        <button type="button" class="btn-close" (click)="mensaje = ''" aria-label="Close"></button>
      </div>

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3" (click)="toggleSeccion('vitales')" style="cursor: pointer;">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-heart-pulse me-2 text-danger"></i>
            Signos Vitales
            <i class="bi float-end" [ngClass]="seccionSignosVitales ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </h5>
        </div>
        <div class="card-body p-4" *ngIf="seccionSignosVitales">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label fw-semibold">Peso (kg)</label>
              <input type="number" class="form-control" step="0.01" 
                     [(ngModel)]="consultaData.peso_actual" placeholder="Ej: 15.5">
            </div>
            <div class="col-md-3">
              <label class="form-label fw-semibold">Temperatura (°C)</label>
              <input type="number" class="form-control" step="0.1" 
                     [(ngModel)]="consultaData.temperatura" placeholder="Ej: 38.5">
            </div>
            <div class="col-md-3">
              <label class="form-label fw-semibold">Frecuencia Cardíaca (lpm)</label>
              <input type="number" class="form-control" 
                     [(ngModel)]="consultaData.frecuencia_cardiaca" placeholder="Ej: 120">
            </div>
            <div class="col-md-3">
              <label class="form-label fw-semibold">Frecuencia Respiratoria (rpm)</label>
              <input type="number" class="form-control" 
                     [(ngModel)]="consultaData.frecuencia_respiratoria" placeholder="Ej: 30">
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-3">
            <i class="bi bi-file-text me-2 text-primary"></i>
            Información General
          </h5>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label fw-semibold">Motivo de Consulta <span class="text-danger">*</span></label>
              <textarea class="form-control" rows="2" required
                        [(ngModel)]="consultaData.motivo_consulta" 
                        placeholder="Describa el motivo de la consulta..."></textarea>
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold">Síntomas</label>
              <textarea class="form-control" rows="3"
                        [(ngModel)]="consultaData.sintomas" 
                        placeholder="Describa los síntomas observados..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3" (click)="toggleSeccion('diagnosticos')" style="cursor: pointer;">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-clipboard-check me-2 text-success"></i>
            Diagnósticos <span class="badge bg-success">{{ diagnosticos.length }}</span>
            <span class="text-danger small ms-2">* Mínimo 1 requerido</span>
            <i class="bi float-end" [ngClass]="seccionDiagnosticos ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </h5>
        </div>
        <div class="card-body p-4" *ngIf="seccionDiagnosticos">
          <!-- Lista de diagnósticos agregados -->
          <div *ngIf="diagnosticos.length > 0" class="mb-4">
            <div *ngFor="let diag of diagnosticos; let i = index" class="alert alert-success d-flex justify-content-between align-items-start">
              <div>
                <strong>{{ diag.tipo }}:</strong> {{ diag.descripcion }}
                <span *ngIf="diag.codigo_cie" class="badge bg-secondary ms-2">CIE: {{ diag.codigo_cie }}</span>
              </div>
              <button type="button" class="btn-close" (click)="eliminarDiagnostico(i)"></button>
            </div>
          </div>

          <!-- Formulario para nuevo diagnóstico -->
          <div class="border rounded p-3 bg-light">
            <h6 class="fw-bold mb-3">Agregar Diagnóstico</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Tipo</label>
                <select class="form-select" [(ngModel)]="nuevoDiagnostico.tipo">
                  <option *ngFor="let tipo of tiposDiagnostico" [value]="tipo">{{ tipo }}</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Código CIE (Opcional)</label>
                <input type="text" class="form-control" [(ngModel)]="nuevoDiagnostico.codigo_cie" placeholder="Ej: A09">
              </div>
              <div class="col-12">
                <label class="form-label">Descripción del Diagnóstico</label>
                <textarea class="form-control" rows="2" [(ngModel)]="nuevoDiagnostico.descripcion"
                          placeholder="Ej: Gastroenteritis aguda..."></textarea>
              </div>
              <div class="col-12">
                <button type="button" class="btn btn-success" (click)="agregarDiagnostico()">
                  <i class="bi bi-plus-circle me-1"></i> Agregar Diagnóstico
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3" (click)="toggleSeccion('tratamientos')" style="cursor: pointer;">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-capsule me-2 text-info"></i>
            Tratamientos <span class="badge bg-info">{{ tratamientos.length }}</span>
            <i class="bi float-end" [ngClass]="seccionTratamientos ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </h5>
        </div>
        <div class="card-body p-4" *ngIf="seccionTratamientos">
          <!-- Lista de tratamientos agregados -->
          <div *ngIf="tratamientos.length > 0" class="mb-4">
            <div *ngFor="let trat of tratamientos; let i = index" class="alert alert-info d-flex justify-content-between align-items-start">
              <div>
                <strong>{{ trat.medicamento }}</strong> - {{ trat.dosis }}, {{ trat.frecuencia }}
                <span *ngIf="trat.duracion_dias"> ({{ trat.duracion_dias }} días)</span>
                <br><small class="text-muted">Vía: {{ trat.via_administracion }}</small>
              </div>
              <button type="button" class="btn-close" (click)="eliminarTratamiento(i)"></button>
            </div>
          </div>

          <!-- Formulario para nuevo tratamiento -->
          <div class="border rounded p-3 bg-light">
            <h6 class="fw-bold mb-3">Agregar Tratamiento</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Medicamento</label>
                <input type="text" class="form-control" [(ngModel)]="nuevoTratamiento.medicamento" 
                       placeholder="Ej: Amoxicilina">
              </div>
              <div class="col-md-6">
                <label class="form-label">Principio Activo</label>
                <input type="text" class="form-control" [(ngModel)]="nuevoTratamiento.principio_activo" 
                       placeholder="Ej: Amoxicilina trihidratada">
              </div>
              <div class="col-md-4">
                <label class="form-label">Dosis</label>
                <input type="text" class="form-control" [(ngModel)]="nuevoTratamiento.dosis" 
                       placeholder="Ej: 250mg">
              </div>
              <div class="col-md-4">
                <label class="form-label">Frecuencia</label>
                <input type="text" class="form-control" [(ngModel)]="nuevoTratamiento.frecuencia" 
                       placeholder="Ej: Cada 8 horas">
              </div>
              <div class="col-md-4">
                <label class="form-label">Duración (días)</label>
                <input type="number" class="form-control" [(ngModel)]="nuevoTratamiento.duracion_dias" 
                       placeholder="Ej: 7">
              </div>
              <div class="col-md-6">
                <label class="form-label">Vía de Administración</label>
                <select class="form-select" [(ngModel)]="nuevoTratamiento.via_administracion">
                  <option *ngFor="let via of viasAdministracion" [value]="via">{{ via }}</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Indicaciones</label>
                <input type="text" class="form-control" [(ngModel)]="nuevoTratamiento.indicaciones" 
                       placeholder="Ej: Administrar con alimento">
              </div>
              <div class="col-12">
                <button type="button" class="btn btn-info" (click)="agregarTratamiento()">
                  <i class="bi bi-plus-circle me-1"></i> Agregar Tratamiento
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3" (click)="toggleSeccion('vacunas')" style="cursor: pointer;">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-shield-check me-2 text-warning"></i>
            Vacunas <span class="badge bg-warning text-dark">{{ vacunas.length }}</span>
            <i class="bi float-end" [ngClass]="seccionVacunas ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </h5>
        </div>
        <div class="card-body p-4" *ngIf="seccionVacunas">
          <!-- Lista de vacunas agregadas -->
          <div *ngIf="vacunas.length > 0" class="mb-4">
            <div *ngFor="let vac of vacunas; let i = index" class="alert alert-warning d-flex justify-content-between align-items-start">
              <div>
                <strong>{{ vac.nombre_vacuna }}</strong> - {{ vac.fecha_aplicacion }}
                <span *ngIf="vac.laboratorio" class="badge bg-secondary ms-2">{{ vac.laboratorio }}</span>
                <br *ngIf="vac.proxima_dosis">
                <small class="text-muted" *ngIf="vac.proxima_dosis">Próxima dosis: {{ vac.proxima_dosis }}</small>
              </div>
              <button type="button" class="btn-close" (click)="eliminarVacuna(i)"></button>
            </div>
          </div>

          <!-- Formulario para nueva vacuna -->
          <div class="border rounded p-3 bg-light">
            <h6 class="fw-bold mb-3">Agregar Vacuna</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre de la Vacuna</label>
                <input type="text" class="form-control" [(ngModel)]="nuevaVacuna.nombre_vacuna" 
                       placeholder="Ej: Antirrábica">
              </div>
              <div class="col-md-6">
                <label class="form-label">Laboratorio</label>
                <input type="text" class="form-control" [(ngModel)]="nuevaVacuna.laboratorio" 
                       placeholder="Ej: Zoetis">
              </div>
              <div class="col-md-4">
                <label class="form-label">Lote</label>
                <input type="text" class="form-control" [(ngModel)]="nuevaVacuna.lote" 
                       placeholder="Ej: LOT123456">
              </div>
              <div class="col-md-4">
                <label class="form-label">Fecha de Aplicación</label>
                <input type="date" class="form-control" [(ngModel)]="nuevaVacuna.fecha_aplicacion">
              </div>
              <div class="col-md-4">
                <label class="form-label">Próxima Dosis</label>
                <input type="date" class="form-control" [(ngModel)]="nuevaVacuna.proxima_dosis">
              </div>
              <div class="col-md-6">
                <label class="form-label">Vía de Administración</label>
                <select class="form-select" [(ngModel)]="nuevaVacuna.via_administracion">
                  <option value="Subcutánea">Subcutánea</option>
                  <option value="Intramuscular">Intramuscular</option>
                  <option value="Intranasal">Intranasal</option>
                  <option value="Oral">Oral</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Sitio de Aplicación</label>
                <input type="text" class="form-control" [(ngModel)]="nuevaVacuna.sitio_aplicacion" 
                       placeholder="Ej: Región interescapular">
              </div>
              <div class="col-12">
                <label class="form-label">Reacciones Adversas</label>
                <textarea class="form-control" rows="2" [(ngModel)]="nuevaVacuna.reacciones_adversas"
                          placeholder="Describa cualquier reacción adversa observada..."></textarea>
              </div>
              <div class="col-12">
                <button type="button" class="btn btn-warning" (click)="agregarVacuna()">
                  <i class="bi bi-plus-circle me-1"></i> Agregar Vacuna
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3" (click)="toggleSeccion('procedimientos')" style="cursor: pointer;">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-scissors me-2 text-danger"></i>
            Procedimientos <span class="badge bg-danger">{{ procedimientos.length }}</span>
            <i class="bi float-end" [ngClass]="seccionProcedimientos ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </h5>
        </div>
        <div class="card-body p-4" *ngIf="seccionProcedimientos">
          <!-- Lista de procedimientos agregados -->
          <div *ngIf="procedimientos.length > 0" class="mb-4">
            <div *ngFor="let proc of procedimientos; let i = index" class="alert alert-danger bg-opacity-10 d-flex justify-content-between align-items-start">
              <div>
                <strong>{{ proc.tipo_procedimiento }}:</strong> {{ proc.nombre_procedimiento }}
                <br><small class="text-muted">{{ proc.descripcion }}</small>
                <br><small class="text-muted">Resultado: {{ proc.resultado }}</small>
              </div>
              <button type="button" class="btn-close" (click)="eliminarProcedimiento(i)"></button>
            </div>
          </div>

          <!-- Formulario para nuevo procedimiento -->
          <div class="border rounded p-3 bg-light">
            <h6 class="fw-bold mb-3">Agregar Procedimiento</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Tipo de Procedimiento</label>
                <select class="form-select" [(ngModel)]="nuevoProcedimiento.tipo_procedimiento">
                  <option value="">Seleccione...</option>
                  <option *ngFor="let tipo of tiposProcedimiento" [value]="tipo">{{ tipo }}</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Nombre del Procedimiento</label>
                <input type="text" class="form-control" [(ngModel)]="nuevoProcedimiento.nombre_procedimiento" 
                       placeholder="Ej: Esterilización por ovariohisterectomía">
              </div>
              <div class="col-12">
                <label class="form-label">Descripción</label>
                <textarea class="form-control" rows="3" [(ngModel)]="nuevoProcedimiento.descripcion"
                          placeholder="Describa el procedimiento realizado..."></textarea>
              </div>
              <div class="col-md-4">
                <label class="form-label">Fecha de Realización</label>
                <input type="date" class="form-control" [(ngModel)]="nuevoProcedimiento.fecha_realizacion">
              </div>
              <div class="col-md-4">
                <label class="form-label">Hora de Inicio</label>
                <input type="time" class="form-control" [(ngModel)]="nuevoProcedimiento.hora_inicio">
              </div>
              <div class="col-md-4">
                <label class="form-label">Duración (minutos)</label>
                <input type="number" class="form-control" [(ngModel)]="nuevoProcedimiento.duracion_minutos" 
                       placeholder="Ej: 45">
              </div>
              <div class="col-md-6">
                <label class="form-label">Anestesia Utilizada</label>
                <input type="text" class="form-control" [(ngModel)]="nuevoProcedimiento.anestesia_utilizada" 
                       placeholder="Ej: Isoflurano">
              </div>
              <div class="col-md-6">
                <label class="form-label">Resultado</label>
                <select class="form-select" [(ngModel)]="nuevoProcedimiento.resultado">
                  <option value="Exitoso">Exitoso</option>
                  <option value="Complicaciones Menores">Complicaciones Menores</option>
                  <option value="Complicaciones Mayores">Complicaciones Mayores</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Observaciones</label>
                <textarea class="form-control" rows="2" [(ngModel)]="nuevoProcedimiento.observaciones"
                          placeholder="Observaciones adicionales..."></textarea>
              </div>
              <div class="col-12">
                <button type="button" class="btn btn-danger" (click)="agregarProcedimiento()">
                  <i class="bi bi-plus-circle me-1"></i> Agregar Procedimiento
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3" (click)="toggleSeccion('imagenes')" style="cursor: pointer;">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-image me-2 text-primary"></i>
            Imágenes Médicas <span class="badge bg-primary">{{ imagenes.length }}</span>
            <i class="bi float-end" [ngClass]="seccionImagenes ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </h5>
        </div>
        <div class="card-body p-4" *ngIf="seccionImagenes">
          <!-- Lista de imágenes agregadas -->
          <div *ngIf="imagenes.length > 0" class="mb-4">
            <div *ngFor="let img of imagenes; let i = index" class="alert alert-primary bg-opacity-10 d-flex justify-content-between align-items-start">
              <div>
                <strong>{{ img.tipo_imagen }}</strong>
                <br><small class="text-muted">{{ img.url_imagen }}</small>
                <br *ngIf="img.descripcion"><small>{{ img.descripcion }}</small>
              </div>
              <button type="button" class="btn-close" (click)="eliminarImagen(i)"></button>
            </div>
          </div>

          <!-- Formulario para nueva imagen -->
          <div class="border rounded p-3 bg-light">
            <h6 class="fw-bold mb-3">Agregar Imagen</h6>
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              <small>Las imágenes se guardan como enlaces URL. Asegúrate de que la URL sea accesible.</small>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Tipo de Imagen</label>
                <select class="form-select" [(ngModel)]="nuevaImagen.tipo_imagen">
                  <option *ngFor="let tipo of tiposImagen" [value]="tipo">{{ tipo }}</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">URL de la Imagen</label>
                <input type="url" class="form-control" [(ngModel)]="nuevaImagen.url_imagen" 
                       placeholder="https://ejemplo.com/imagen.jpg">
              </div>
              <div class="col-12">
                <label class="form-label">Descripción</label>
                <input type="text" class="form-control" [(ngModel)]="nuevaImagen.descripcion" 
                       placeholder="Ej: Radiografía de cadera derecha">
              </div>
              <div class="col-12">
                <button type="button" class="btn btn-primary" (click)="agregarImagen()">
                  <i class="bi bi-plus-circle me-1"></i> Agregar Imagen
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-3">
            <i class="bi bi-pencil-square me-2 text-secondary"></i>
            Observaciones Finales
          </h5>
          <textarea class="form-control" rows="4" [(ngModel)]="consultaData.observaciones"
                    placeholder="Observaciones generales, recomendaciones, seguimiento..."></textarea>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="card border-0 shadow-sm mb-5">
        <div class="card-body p-4">
          <div class="d-flex gap-3 justify-content-between">
            <button type="button" class="btn btn-outline-secondary btn-lg px-5" 
                    (click)="cancelar()" [disabled]="cargando">
              <i class="bi bi-x-circle me-2"></i>
              Cancelar
            </button>
            
            <button type="button" class="btn btn-success btn-lg px-5 flex-grow-1" 
                    (click)="registrarConsulta()" [disabled]="cargando">
              <span *ngIf="!cargando">
                <i class="bi bi-check-circle me-2"></i>
                Registrar Consulta Completa
              </span>
              <span *ngIf="cargando">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Guardando...
              </span>
            </button>
          </div>
          
          <div class="alert alert-info mt-3 mb-0">
            <i class="bi bi-info-circle me-2"></i>
            <small>
              Al registrar, se creará/actualizará el expediente médico y la cita será marcada como <strong>Completada</strong>.
              Se registrarán: <strong>{{ diagnosticos.length }}</strong> diagnóstico(s), 
              <strong>{{ tratamientos.length }}</strong> tratamiento(s), 
              <strong>{{ vacunas.length }}</strong> vacuna(s), 
              <strong>{{ procedimientos.length }}</strong> procedimiento(s), 
              <strong>{{ imagenes.length }}</strong> imagen(es).
            </small>
          </div>
        </div>
      </div>

    </div>
  </div>
</div><p>expediente-form works!</p>
