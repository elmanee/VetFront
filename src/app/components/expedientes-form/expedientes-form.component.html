<div class="clinical-container py-4">
  
  <!-- ==========================================
       HEADER DE CONTEXTO (Banner del Paciente)
       ========================================== -->
  <div class="patient-banner card border-0 shadow-sm rounded-4 mb-4" *ngIf="cita">
    <div class="card-body p-4">
      <div class="row align-items-center">
        <!-- Avatar y Nombre -->
        <div class="col-md-5 d-flex align-items-center gap-3 border-end-md">
          <div class="avatar-box">
             <i class="bi bi-gitlab fs-2" *ngIf="cita.animal_nombre === 'Gato'"></i> <!-- Ejemplo lógica -->
             <i class="bi bi-heart-pulse-fill fs-2" *ngIf="cita.animal_nombre !== 'Gato'"></i>
          </div>
          <div>
            <span class="badge bg-warning-subtle text-warning-emphasis mb-1">EN CONSULTA</span>
            <h3 class="mb-0 fw-bold text-dark">{{ cita.mascota_nombre || 'Paciente Nuevo' }}</h3>
            <p class="text-muted mb-0 small">Propietario: {{ cita.cliente_nombre }}</p>
          </div>
        </div>

        <!-- Detalles Cita -->
        <div class="col-md-4 py-3 py-md-0 border-end-md ps-md-4">
          <label class="info-label">MOTIVO DE VISITA</label>
          <p class="info-value mb-0 text-truncate">{{ cita.motivo }}</p>
        </div>

        <!-- Fecha/Hora -->
        <div class="col-md-3 ps-md-4 text-md-end">
           <div class="d-inline-block text-start">
             <label class="info-label">FECHA</label>
             <p class="info-value mb-0">
               {{ cita.fecha_cita | date:'dd MMM yyyy' }} <span class="text-muted mx-1">|</span> {{ cita.hora_cita }}
             </p>
           </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="cargandoDatos" class="text-center py-5 bg-white rounded-4 shadow-sm">
    <div class="spinner-border text-primary-custom" role="status" style="width: 3rem; height: 3rem;"></div>
    <p class="mt-3 text-muted fw-bold">Preparando expediente clínico...</p>
  </div>

  <!-- MODAL LISTA DE EXPEDIENTES -->
  <app-modal-expedientes-lista
    *ngIf="mostrarModalExpedientes"
    [paciente]="paciente"
    [expedientes]="expedientesDisponibles"
    (expedienteSeleccionado)="onExpedienteSeleccionado($event)"
    (crearNuevoExpediente)="onCrearNuevoExpedienteDesdeModal()"
    (cerrarModal)="onCerrarModal()">
  </app-modal-expedientes-lista>

  <!-- CREAR PACIENTE (Si no existe) -->
  <div *ngIf="mostrarCrearPaciente && !cargandoDatos" class="action-card card shadow-sm border-0 rounded-4 p-5 mb-4 text-center">
    <div class="mx-auto mb-3 icon-circle-lg bg-warning-subtle text-warning-dark">
      <i class="bi bi-person-plus-fill"></i>
    </div>
    <h3 class="fw-bold text-dark">Paciente Nuevo Detectado</h3>
    <p class="text-muted mb-4">Antes de iniciar la consulta, necesitamos crear el perfil básico del paciente.</p>
    
    <div class="text-start mx-auto" style="max-width: 800px;">
       <app-crear-paciente
         [cita]="cita"
         (pacienteCreado)="onPacienteCreado($event)">
       </app-crear-paciente>
    </div>
  </div>

  <!-- ==========================================
       ÁREA DE TRABAJO (TABS)
       ========================================== -->
  <div *ngIf="mostrarTabs && !cargandoDatos" class="clinical-workspace card shadow-sm border-0 rounded-4 overflow-hidden">

    <!-- Alerta de Edición -->
    <div *ngIf="modoEdicion" class="edit-mode-bar px-4 py-2 d-flex align-items-center gap-2">
      <i class="bi bi-pencil-fill"></i>
      <span class="fw-bold small text-uppercase">Modo Edición Activo</span>
      <span class="ms-auto font-monospace small">Expediente #{{ expediente?.id_expediente }}</span>
    </div>

    <!-- Navegación de Tabs (Estilo Folder) -->
    <div class="tabs-header bg-light border-bottom px-3 pt-3">
      <ul class="nav nav-tabs border-0 gap-2">
        
        <li class="nav-item">
          <button class="nav-link" [class.active]="tabActiva === 'consulta'"
                  (click)="cambiarTab('consulta')" [disabled]="!tabs.consulta">
            <span class="step-text">Signos y Anamnesis</span>
          </button>
        </li>

        <li class="nav-item">
          <button class="nav-link" [class.active]="tabActiva === 'diagnosticos'"
                  (click)="cambiarTab('diagnosticos')" [disabled]="!tabs.diagnosticos">
            <span class="step-text">Diagnóstico</span>
          </button>
        </li>

        <li class="nav-item">
          <button class="nav-link" [class.active]="tabActiva === 'tratamientos'"
                  (click)="cambiarTab('tratamientos')" [disabled]="!tabs.tratamientos">
            <span class="step-text">Tratamiento</span>
          </button>
        </li>

        <li class="nav-item">
          <button class="nav-link" [class.active]="tabActiva === 'vacunas'"
                  (click)="cambiarTab('vacunas')" [disabled]="!tabs.vacunas">
            <span class="step-text">Vacunas</span>
          </button>
        </li>
        
        <!-- Dropdown para extras en pantallas chicas o pestañas finales -->
        <li class="nav-item d-none d-lg-block">
          <button class="nav-link" [class.active]="tabActiva === 'procedimientos'"
                  (click)="cambiarTab('procedimientos')" [disabled]="!tabs.procedimientos">
            <span class="step-text">Procedimientos</span>
          </button>
        </li>

        <li class="nav-item d-none d-lg-block">
          <button class="nav-link" [class.active]="tabActiva === 'imagenes'"
                  (click)="cambiarTab('imagenes')" [disabled]="!tabs.imagenes">
            <span class="step-text">Evidencia</span>
          </button>
        </li>

      </ul>
    </div>

    <!-- Contenido dinámico -->
    <div class="tab-content bg-white p-4 p-lg-5">

      <!-- TAB 1: CONSULTA -->
      <div class="tab-pane fade show active" *ngIf="tabActiva === 'consulta'">
        <div class="section-guide mb-4">
          <h5 class="guide-title text-primary-custom">Evaluación Inicial</h5>
          <p class="guide-subtitle text-muted">Registre los signos vitales actuales y la descripción detallada del problema.</p>
        </div>
        <app-tab-consulta
          [cita]="cita"
          [expediente]="expediente"
          [modoEdicion]="modoEdicion"
          [consultaExistente]="expedienteCompleto?.ultima_consulta"
          (consultaCreada)="onConsultaCreada($event)">
        </app-tab-consulta>
      </div>

      <!-- TAB 2: DIAGNÓSTICOS -->
      <div class="tab-pane fade show active" *ngIf="tabActiva === 'diagnosticos'">
        <div class="section-guide mb-4">
          <h5 class="guide-title text-primary-custom">Dictamen Médico</h5>
          <p class="guide-subtitle text-muted">Añada diagnósticos presuntivos o definitivos basados en la evaluación.</p>
        </div>
        
        <div *ngIf="!consulta" class="alert alert-warning-custom">
          <i class="bi bi-lock-fill me-2"></i>Complete la evaluación inicial para desbloquear esta sección.
        </div>
        <div *ngIf="consulta">
          <app-tab-diagnosticos [consulta]="consulta" [modoEdicion]="modoEdicion" (guardado)="goToNextTab()"></app-tab-diagnosticos>
        </div>
      </div>

      <!-- TAB 3: TRATAMIENTOS -->
      <div class="tab-pane fade show active" *ngIf="tabActiva === 'tratamientos'">
        <div class="section-guide mb-4">
          <h5 class="guide-title text-primary-custom">Plan Terapéutico</h5>
          <p class="guide-subtitle text-muted">Recete medicamentos y establezca la frecuencia de administración.</p>
        </div>
        
        <div *ngIf="!consulta" class="alert alert-warning-custom"><i class="bi bi-lock-fill me-2"></i>Sección bloqueada.</div>
        <div *ngIf="consulta">
          <app-tab-tratamientos [consulta]="consulta" [modoEdicion]="modoEdicion" (guardado)="goToNextTab()"></app-tab-tratamientos>
        </div>
      </div>

      <!-- TAB 4: VACUNAS -->
      <div class="tab-pane fade show active" *ngIf="tabActiva === 'vacunas'">
        <div class="section-guide mb-4">
           <h5 class="guide-title text-primary-custom">Inmunización</h5>
           <p class="guide-subtitle text-muted">Registre aplicación de biológicos si aplica en esta visita.</p>
        </div>
        <div *ngIf="consulta">
          <app-tab-vacunas [consulta]="consulta" [modoEdicion]="modoEdicion" (guardado)="goToNextTab()"></app-tab-vacunas>
        </div>
      </div>

      <!-- TAB 5: PROCEDIMIENTOS -->
      <div class="tab-pane fade show active" *ngIf="tabActiva === 'procedimientos'">
         <div class="section-guide mb-4">
           <h5 class="guide-title text-primary-custom">Intervenciones</h5>
           <p class="guide-subtitle text-muted">Cirugías menores, curaciones o procedimientos realizados.</p>
        </div>
        <div *ngIf="consulta">
          <app-tab-procedimientos [consulta]="consulta" [modoEdicion]="modoEdicion" (guardado)="goToNextTab()"></app-tab-procedimientos>
        </div>
      </div>

      <!-- TAB 6: IMÁGENES -->
      <div class="tab-pane fade show active" *ngIf="tabActiva === 'imagenes'">
        <div class="section-guide mb-4">
           <h5 class="guide-title text-primary-custom">Evidencia Digital</h5>
           <p class="guide-subtitle text-muted">Adjunte fotografías, radiografías o resultados de laboratorio.</p>
        </div>
        <div *ngIf="consulta">
          <app-tab-imagenes [consulta]="consulta" [modoEdicion]="modoEdicion" (guardado)="goToNextTab()"></app-tab-imagenes>
        </div>
      </div>

    </div>
  </div>

  <!-- FOOTER DE ACCIÓN (Sticky Bottom opcional o estático) -->
  <div class="form-actions mt-4 d-flex justify-content-between align-items-center" *ngIf="consulta && !cargandoDatos">
    <button class="btn btn-link text-muted text-decoration-none" (click)="volver()">
      <i class="bi bi-x-circle me-1"></i> Cancelar / Salir
    </button>
    
    <button class="btn btn-finish px-5 py-3 rounded-pill fw-bold shadow-lg" (click)="finalizarAtencion()">
      <i class="bi bi-check-circle-fill me-2"></i>
      GUARDAR Y FINALIZAR CONSULTA
    </button>
  </div>

</div>
