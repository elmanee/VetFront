<div class="container py-4">

  <!-- Título principal -->
  <h2 class="fw-bold text-primary-si mb-2">Atender Cita</h2>

  <p class="text-muted mb-4">
    {{ cita?.cliente_nombre }} · {{ cita?.animal_nombre }} ·
    {{ cita?.fecha_cita | date:'mediumDate' }} · {{ cita?.hora_cita }}
  </p>

  <div *ngIf="cargandoDatos" class="text-center py-5">
    <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3 text-muted fw-semibold">
      <i class="bi bi-hourglass-split me-2"></i>
      Cargando información del paciente...
    </p>
  </div>

  <app-modal-expedientes-lista
    *ngIf="mostrarModalExpedientes"
    [paciente]="paciente"
    [expedientes]="expedientesDisponibles"
    (expedienteSeleccionado)="onExpedienteSeleccionado($event)"
    (crearNuevoExpediente)="onCrearNuevoExpedienteDesdeModal()"
    (cerrarModal)="onCerrarModal()">
  </app-modal-expedientes-lista>

  <div *ngIf="mostrarCrearPaciente && !cargandoDatos" class="card shadow-sm border-0 rounded-4 p-4 mb-4">
    <h4 class="fw-semibold text-secondary-si mb-3">
      <i class="bi bi-plus-circle me-2"></i>
      Registrar paciente
    </h4>

    <app-crear-paciente
      [cita]="cita"
      (pacienteCreado)="onPacienteCreado($event)">
    </app-crear-paciente>
  </div>

  <div *ngIf="mostrarTabs && !cargandoDatos" class="card shadow-sm border-0 rounded-4 p-0 overflow-hidden">

    <div *ngIf="modoEdicion" class="alert alert-info mb-0 rounded-0 text-center border-0"
         style="background-color: #D1ECF1; border-bottom: 3px solid #0C5460 !important;">
      <i class="bi bi-pencil-square me-2"></i>
      <strong>Modo Edición:</strong> Estás trabajando con un expediente existente
      <span class="badge bg-primary ms-2">Expediente #{{ expediente?.id_expediente }}</span>
    </div>

    <!-- Encabezado de tabs -->
    <ul class="nav nav-tabs px-3 pt-3 bg-light">

      <!-- TAB CONSULTA -->
      <li class="nav-item">
        <button class="nav-link active"
                id="btn_consulta"
                data-bs-toggle="tab"
                data-bs-target="#consultaTab"
                [disabled]="!tabs.consulta">
          <i class="bi bi-clipboard-pulse me-1"></i>
          Consulta
        </button>
      </li>

      <!-- TAB DIAGNÓSTICOS -->
      <li class="nav-item">
        <button class="nav-link"
                id="btn_diagnosticos"
                data-bs-toggle="tab"
                data-bs-target="#diagTab"
                [disabled]="!tabs.diagnosticos">
          <i class="bi bi-file-medical me-1"></i>
          Diagnósticos
        </button>
      </li>

      <!-- TAB TRATAMIENTOS -->
      <li class="nav-item">
        <button class="nav-link"
                id="btn_tratamientos"
                data-bs-toggle="tab"
                data-bs-target="#tratTab"
                [disabled]="!tabs.tratamientos">
          <i class="bi bi-prescription2 me-1"></i>
          Tratamientos
        </button>
      </li>

      <!-- TAB VACUNAS -->
      <li class="nav-item">
        <button class="nav-link"
                id="btn_vacunas"
                data-bs-toggle="tab"
                data-bs-target="#vacTab"
                [disabled]="!tabs.vacunas">
          <i class="bi bi-shield-check me-1"></i>
          Vacunas
        </button>
      </li>

      <!-- TAB PROCEDIMIENTOS -->
      <li class="nav-item">
        <button class="nav-link"
                id="btn_procedimientos"
                data-bs-toggle="tab"
                data-bs-target="#procTab"
                [disabled]="!tabs.procedimientos">
          <i class="bi bi-tools me-1"></i>
          Procedimientos
        </button>
      </li>

      <!-- TAB IMÁGENES -->
      <li class="nav-item">
        <button class="nav-link"
                id="btn_imagenes"
                data-bs-toggle="tab"
                data-bs-target="#imgTab"
                [disabled]="!tabs.imagenes">
          <i class="bi bi-images me-1"></i>
          Imágenes
        </button>
      </li>

    </ul>

    <!-- Contenido de tabs -->
    <div class="tab-content p-4">

      <!-- TAB CONSULTA -->
      <div class="tab-pane fade show active" id="consultaTab">
        <app-tab-consulta
          [cita]="cita"
          [expediente]="expediente"
          [modoEdicion]="modoEdicion"
          [consultaExistente]="expedienteCompleto?.ultima_consulta"
          (consultaCreada)="onConsultaCreada($event)">
        </app-tab-consulta>
      </div>

      <!-- TAB DIAGNÓSTICOS -->
      <div class="tab-pane fade" id="diagTab">
        <div *ngIf="!consulta" class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Primero debes registrar la consulta.
        </div>

        <div *ngIf="consulta">
          <app-tab-diagnosticos
            [consulta]="consulta"
            [modoEdicion]="modoEdicion"
            (guardado)="goToNextTab()">
          </app-tab-diagnosticos>
        </div>
      </div>

      <!-- TAB TRATAMIENTOS -->
      <div class="tab-pane fade" id="tratTab">
        <div *ngIf="!consulta" class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Primero debes registrar la consulta.
        </div>

        <div *ngIf="consulta">
          <app-tab-tratamientos
            [consulta]="consulta"
            [modoEdicion]="modoEdicion"
            (guardado)="goToNextTab()">
          </app-tab-tratamientos>
        </div>
      </div>

      <!-- TAB VACUNAS -->
      <div class="tab-pane fade" id="vacTab">
        <div *ngIf="!consulta" class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Primero debes registrar la consulta.
        </div>

        <div *ngIf="consulta">
          <app-tab-vacunas
            [consulta]="consulta"
            [modoEdicion]="modoEdicion"
            (guardado)="goToNextTab()">
          </app-tab-vacunas>
        </div>
      </div>

      <!-- TAB PROCEDIMIENTOS -->
      <div class="tab-pane fade" id="procTab">
        <div *ngIf="!consulta" class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Primero debes registrar la consulta.
        </div>

        <div *ngIf="consulta">
          <app-tab-procedimientos
            [consulta]="consulta"
            [modoEdicion]="modoEdicion"
            (guardado)="goToNextTab()">
          </app-tab-procedimientos>
        </div>
      </div>

      <!-- TAB IMÁGENES -->
      <div class="tab-pane fade" id="imgTab">
        <div *ngIf="!consulta" class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Primero debes registrar la consulta.
        </div>

        <div *ngIf="consulta">
          <app-tab-imagenes
            [consulta]="consulta"
            [modoEdicion]="modoEdicion"
            (guardado)="goToNextTab()">
          </app-tab-imagenes>
        </div>
      </div>

    </div>
  </div>

  <!-- BOTÓN FINALIZAR ATENCIÓN -->
  <div class="text-end mt-3" *ngIf="consulta && !cargandoDatos">
    <button class="btn btn-success px-4 shadow" (click)="finalizarAtencion()">
      <i class="bi bi-check-circle me-2"></i>
      Finalizar Atención
    </button>
  </div>

</div>
