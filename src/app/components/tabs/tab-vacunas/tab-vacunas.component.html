<div class="card border-0 shadow-sm rounded-4 p-4">

  <form [formGroup]="form">

    <div formArrayName="vacunas">

      <div *ngFor="let vac of vacunasArr.controls; let i = index"
           [formGroupName]="i"
           class="border rounded-4 p-3 mb-3 bg-light-subtle">

        <div class="mb-3 pb-3 border-bottom">
            <label class="form-label fw-bold text-primary">
                <i class="bi bi-box-seam me-1"></i> Vincular con Inventario (Opcional)
            </label>
            
            <select class="form-select" formControlName="producto_id" (change)="onProductoChange(i)">
                <option [ngValue]="null">-- Ninguno (Solo registro médico) --</option>
                
                <option *ngFor="let prod of productosInventario" [ngValue]="prod.id">
                    {{ prod.nombre }} 
                    </option>
            </select>
            
            <div class="form-text text-muted mt-1">
                <small><i class="bi bi-info-circle"></i> Al seleccionar un producto, se descontará 1 unidad del inventario automáticamente al guardar.</small>
            </div>
        </div>
        <div class="row g-3">

          <div class="col-md-4">
            <label class="form-label fw-semibold">Nombre de la vacuna</label>
            <input class="form-control" formControlName="nombre_vacuna"
                   (change)="calcularProximaDosis(i)" />
          </div>

          <div class="col-md-3">
            <label class="form-label fw-semibold">Fecha de aplicación</label>
            <input type="date" class="form-control"
                   formControlName="fecha_aplicacion"
                   (change)="calcularProximaDosis(i)" />
          </div>

          <div class="col-md-3">
            <label class="form-label fw-semibold">Próxima dosis</label>
            <input type="date" class="form-control" formControlName="proxima_dosis" readonly />
          </div>

          <div class="col-md-5">
            <label class="form-label fw-semibold">Sitio de aplicación</label>
            <input class="form-control" formControlName="sitio_aplicacion" placeholder="Ej. Lomo, Pierna izquierda" />
          </div>

          <div class="col-md-7">
            <label class="form-label fw-semibold">Reacciones adversas</label>
            <textarea class="form-control" rows="1" formControlName="reacciones_adversas" placeholder="Ninguna"></textarea>
          </div>

        </div>

        <div class="text-end mt-2">
          <button type="button"
                  class="btn btn-outline-danger btn-sm"
                  (click)="quitarVacuna(i)"
                  *ngIf="vacunasArr.length > 1">
            <i class="bi bi-trash me-1"></i> Eliminar
          </button>
        </div>

      </div>

    </div>

    <div class="d-flex justify-content-between mt-4">

      <button type="button" class="btn btn-outline-primary"
              (click)="agregarVacuna()">
        <i class="bi bi-plus-lg me-1"></i> Añadir otra vacuna
      </button>

      <button type="button"
              class="btn btn-primary px-4"
              [disabled]="loading"
              (click)="guardar()">
        <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Guardar cambios
      </button>

    </div>

  </form>

</div>